{% load i18n %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <title>–î–∞—à–±–æ—Ä–¥ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</title>

    <!-- Font Awesome -->
    <link
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        rel="stylesheet"
    />
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
        rel="stylesheet"
    />

    <!-- Bootstrap 5 -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous"
    />

    <style>
        body {
            background-color: #f8fafc;
            padding: 20px;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }
        .page-header {
            margin-bottom: 1rem;
        }
        .card-kpi .label {
            font-size: .8rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: .03em;
        }
        .card-kpi .value {
            font-size: 1.4rem;
            font-weight: 600;
            color: #212529;
        }
        .filter-block {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: .5rem;
            padding: 1rem 1rem 0.25rem;
            margin-bottom: 1rem;
        }
        .filter-block label {
            font-size: .75rem;
            text-transform: uppercase;
            color: #495057;
            margin-bottom: .25rem;
        }
        .export-btn {
            display: inline-block;
            background-color: #198754;
            color: #fff !important;
            text-decoration: none;
            font-weight: 500;
            border-radius: .5rem;
            padding: .5rem .75rem;
        }
        .export-btn:hover {
            background-color: #146c43;
            color: #fff !important;
        }
        .section-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: .5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        table.table-sm td,
        table.table-sm th {
            font-size: .9rem;
            vertical-align: middle;
        }
        .chart-wrapper {
            position: relative;
            min-height: 260px;
        }
    </style>
</head>
<body>

<div class="page-header d-flex flex-column flex-md-row align-items-md-center justify-content-between">
    <a href="{% url 'admin:index' %}" class="text-decoration-none">
        <p><i class="fas fa-arrow-left-long"></i> –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</p>
    </a>

    <div class="text-center">
        <h1 class="h4 fw-semibold mb-1">üìä –û—Ç—á—ë—Ç –ø–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º</h1>
        <div class="text-muted small">
            –ü–µ—Ä–∏–æ–¥: {{ date_from|date:"Y-m-d" }} ‚Üí {{ date_to|date:"Y-m-d" }}
        </div>
    </div>

    <div class="mt-2 mt-md-0">
        <a class="export-btn"
           href="{% url 'dashboard-export' %}?from={{ date_from|date:'Y-m-d' }}&to={{ date_to|date:'Y-m-d' }}{% if current_partner_id %}&partner={{ current_partner_id }}{% endif %}{% if current_region_id %}&region={{ current_region_id }}{% endif %}">
            üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
        </a>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="filter-block">
    <form class="row g-3 align-items-end" method="get">
        <div class="col-sm-6 col-md-3 col-lg-2">
            <label class="form-label">–° –¥–∞—Ç—ã</label>
            <input class="form-control form-control-sm"
                   type="date" name="from"
                   value="{{ date_from|date:'Y-m-d' }}">
        </div>
        <div class="col-sm-6 col-md-3 col-lg-2">
            <label class="form-label">–ü–æ –¥–∞—Ç—É</label>
            <input class="form-control form-control-sm"
                   type="date" name="to"
                   value="{{ date_to|date:'Y-m-d' }}">
        </div>

        {% if not is_partner_admin %}
        <div class="col-sm-6 col-md-3 col-lg-3">
            <label class="form-label">–ü–∞—Ä—Ç–Ω—ë—Ä</label>
            <select class="form-select form-select-sm" name="partner">
                <option value="">–í—Å–µ</option>
                {% for p in partners %}
                <option value="{{ p.id }}"
                        {% if current_partner_id == p.id %}selected{% endif %}>
                    {{ p.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <div class="col-sm-6 col-md-3 col-lg-3">
            <label class="form-label">–†–µ–≥–∏–æ–Ω</label>
            <select class="form-select form-select-sm" name="region">
                <option value="">–í—Å–µ</option>
                {% for r in regions %}
                <option value="{{ r.id }}"
                        {% if current_region_id == r.id %}selected{% endif %}>
                    {{ r.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-sm-12 col-md-3 col-lg-2">
            <button type="submit" class="btn btn-success btn-sm w-100">
                –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </form>
</div>

<!-- KPI –∫–∞—Ä—Ç–æ—á–∫–∏ -->
<div class="row g-3 mb-3">
    <div class="col-6 col-md-4 col-xl-2">
        <div class="card-kpi p-3 border rounded bg-white h-100">
            <div class="label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</div>
            <div class="value">{{ stats.total_bookings }}</div>
        </div>
    </div>

    <div class="col-6 col-md-4 col-xl-2">
        <div class="card-kpi p-3 border rounded bg-white h-100">
            <div class="label">–û–±–æ—Ä–æ—Ç (UZS)</div>
            <div class="value">{{ stats.total_turnover }}</div>
        </div>
    </div>

    <div class="col-6 col-md-4 col-xl-2">
        <div class="card-kpi p-3 border rounded bg-white h-100">
            <div class="label">–û–ø–ª–∞—á–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç–∞–º–∏</div>
            <div class="value">{{ stats.total_paid }}</div>
        </div>
    </div>

    <div class="col-6 col-md-4 col-xl-3">
        <div class="card-kpi p-3 border rounded bg-white h-100">
            <div class="label">–ö–æ–º–∏—Å—Å–∏—è –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞</div>
            <div class="value">{{ stats.total_commission }}</div>
        </div>
    </div>

    <div class="col-6 col-md-4 col-xl-3">
        <div class="card-kpi p-3 border rounded bg-white h-100">
            <div class="label">–ß–∏—Å—Ç—ã–º–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º</div>
            <div class="value">{{ stats.total_partner_net }}</div>
        </div>
    </div>
</div>

<!-- –†—è–¥: –≥—Ä–∞—Ñ–∏–∫ —Ç–æ–ø –º–∞—à–∏–Ω + —Ç–∞–±–ª–∏—Ü–∞ —Ç–æ–ø –º–∞—à–∏–Ω -->
<div class="row g-3">
    <div class="col-lg-6">
        <div class="section-card h-100">
            <h5 class="mb-3">üöó –¢–æ–ø –∞–≤—Ç–æ –ø–æ –æ–±–æ—Ä–æ—Ç—É</h5>
            <div class="chart-wrapper">
                <canvas id="topCarsChart"></canvas>
            </div>
            {% if not top_cars %}
            <div class="text-muted small mt-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
            {% endif %}
        </div>
    </div>

    <div class="col-lg-6">
        <div class="section-card h-100">
            <h5 class="mb-3">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–ø –∞–≤—Ç–æ</h5>
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>–ê–≤—Ç–æ</th>
                        <th>–û–±–æ—Ä–æ—Ç, UZS</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% if top_cars %}
                    {% for car_name, total_sum in top_cars %}
                    <tr>
                        <td>{{ car_name }}</td>
                        <td>{{ total_sum }}</td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="2" class="text-muted small">
                            –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥
                        </td>
                    </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% if show_partner_chart %}
<!-- –†—è–¥: –≥—Ä–∞—Ñ–∏–∫ —Ç–æ–ø –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ + —Ç–∞–±–ª–∏—Ü–∞ —Ç–æ–ø –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–∞) -->
<div class="row g-3">
    <div class="col-lg-6">
        <div class="section-card h-100">
            <h5 class="mb-3">üè¢ –¢–æ–ø –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –ø–æ –æ–±–æ—Ä–æ—Ç—É</h5>
            <div class="chart-wrapper">
                <canvas id="topPartnersChart"></canvas>
            </div>
            {% if not top_partners %}
            <div class="text-muted small mt-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
            {% endif %}
        </div>
    </div>

    <div class="col-lg-6">
        <div class="section-card h-100">
            <h5 class="mb-3">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤</h5>
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                    <tr>
                        <th>–ü–∞—Ä—Ç–Ω—ë—Ä</th>
                        <th>–û–±–æ—Ä–æ—Ç, UZS</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% if top_partners %}
                    {% for partner_name, total_sum in top_partners %}
                    <tr>
                        <td>{{ partner_name }}</td>
                        <td>{{ total_sum }}</td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="2" class="text-muted small">
                            –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥
                        </td>
                    </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
(function(){
    // –≥—Ä–∞—Ñ–∏–∫ –¢–æ–ø –∞–≤—Ç–æ
    const carLabels = {{ chart_labels|safe }};        // ['BMW m5', 'Audi RS6', ...]
    const carValues = {{ chart_values|safe }};        // [12000000, 8000000, ...]

    const ctxCars = document.getElementById('topCarsChart');
    if (ctxCars && carLabels.length > 0) {
        new Chart(ctxCars, {
            type: 'bar',
            data: {
                labels: carLabels,
                datasets: [{
                    label: '–û–±–æ—Ä–æ—Ç (UZS)',
                    data: carValues,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    // –≥—Ä–∞—Ñ–∏–∫ –¢–æ–ø –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ show_partner_chart === true –Ω–∞ —à–∞–±–ª–æ–Ω–µ
    {% if show_partner_chart %}
    const partnerLabels = {{ partners_chart_labels|safe }};    // ['Partner A', 'Partner B', ...]
    const partnerValues = {{ partners_chart_values|safe }};    // [50000000, 32000000, ...]

    const ctxPartners = document.getElementById('topPartnersChart');
    if (ctxPartners && partnerLabels.length > 0) {
        new Chart(ctxPartners, {
            type: 'bar',
            data: {
                labels: partnerLabels,
                datasets: [{
                    label: '–û–±–æ—Ä–æ—Ç (UZS)',
                    data: partnerValues,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
    {% endif %}
})();
</script>

</body>
</html>
s